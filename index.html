<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>lostamen — 캐릭터 보드</title>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700;900&display=swap" rel="stylesheet">
<style>
:root{--bg:#0b0f14;--panel:#0f1720;--muted:#9aa6b2;--gold:#d4af37;--glass:rgba(255,255,255,.04);--radius:16px;--shadow:0 6px 18px rgba(0,0,0,.5)}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;padding:clamp(10px,2.8vw,22px);font-family:'Noto Sans KR',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(180deg,#071016 0%, #07131a 60%);color:#e6eef6;line-height:1.55}
.container{max-width:1000px;margin:0 auto;display:grid;gap:16px}
.card{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01));border-radius:var(--radius);padding:16px;border:1px solid rgba(255,255,255,.06);box-shadow:var(--shadow)}
.small{font-size:12px;color:var(--muted)}
button{background:transparent;border:1px solid rgba(255,255,255,.12);padding:10px 14px;border-radius:12px;color:var(--gold);cursor:pointer}
button:active{transform:translateY(1px)}
.top-banner,.bottom-banner{background:var(--glass);border-radius:12px;min-height:110px;display:flex;align-items:center;justify-content:center;overflow:hidden}
.top-banner img,.bottom-banner img{width:100%;height:100%;object-fit:cover}
.main{display:grid;grid-template-columns:1fr;gap:16px}
.controls{display:flex;gap:8px;align-items:center;margin-bottom:10px}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
.card-char{background:#0f1720;border-radius:16px;padding:12px;display:flex;flex-direction:column;cursor:pointer;transition:transform .15s ease,box-shadow .15s ease}
.card-char:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(0,0,0,.5)}
.card-char img{width:100%;aspect-ratio:1/1;border-radius:12px;object-fit:cover;background:#061016}
.name{margin:8px 0 2px;font-weight:900;color:var(--gold)}
.meta{font-size:12px;color:var(--muted)}
.row{display:flex;justify-content:space-between;margin-top:6px}

/* 상세 모달 */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:14px;z-index:9999}
.modal.on{display:flex}
.panel{max-width:980px;width:100%;background:#0e141c;border:1px solid rgba(255,255,255,.08);border-radius:16px;display:grid;grid-template-columns:320px 1fr;max-height:92vh;overflow:auto}
.panel .left{padding:14px;border-right:1px solid rgba(255,255,255,.06)}
.panel .right{padding:14px}
.closeX{position:sticky;left:100%;top:10px;background:transparent;border:0;color:#cfd8e3;font-size:22px;cursor:pointer}

.equip{display:grid;gap:10px}
.equip-row{display:grid;grid-template-columns:42px 1fr auto;gap:10px;align-items:center;padding:8px;border:1px solid rgba(255,255,255,.08);border-radius:10px}
.badge{display:inline-block;padding:2px 6px;border-radius:6px;font-weight:800;font-size:11px;background:rgba(255,255,255,.08)}
.qpill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;font-size:12px;background:rgba(255,255,255,.06)}
.opt-lines{display:grid;gap:6px}.opt-line{display:flex;gap:8px;align-items:flex-start}
.tag{display:inline-block;padding:3px 8px;border-radius:999px;font-size:11px;font-weight:800}
.tag.blue{background:rgba(77,171,245,.18);color:#81c9ff}
.tag.purple{background:rgba(162,128,255,.18);color:#c7b5ff}
.tag.orange{background:rgba(255,173,80,.18);color:#ffd29a}
.engr{display:flex;gap:6px;flex-wrap:wrap}
.chip{background:linear-gradient(90deg, rgba(212,175,55,.16), transparent);padding:3px 8px;border-radius:999px;color:#d4af37;font-weight:800;font-size:12px}
.divider{height:1px;background:rgba(255,255,255,.08);margin:10px 0}

/* 보석/카드 */
.gems{display:flex;gap:8px;flex-wrap:wrap}
.gem-pill{padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.06);font-size:12px}
.cards{display:flex;gap:8px;flex-wrap:wrap}
.card-slot{width:68px}.card-slot img{width:68px;height:94px;border-radius:8px;object-fit:cover;border:1px solid rgba(255,255,255,.12)}
.awake{display:block;text-align:center;font-size:12px;margin-top:2px;color:#ffd58a}

/* 스켈레톤 */
.skeleton{position:relative;overflow:hidden;background:linear-gradient(90deg, rgba(255,255,255,.06), transparent)}
.skeleton::after{content:"";position:absolute;inset:0;transform:translateX(-100%);background:linear-gradient(90deg, transparent, rgba(255,255,255,.12), transparent);animation:shimmer 1.4s infinite}
@keyframes shimmer{100%{transform:translateX(100%)}}

/* 반응형 */
@media (max-width:1100px){ .grid{grid-template-columns:repeat(3,1fr)} .panel{grid-template-columns:1fr} .panel .left{border-right:0;border-bottom:1px solid rgba(255,255,255,.06)} }
@media (max-width:760px){ .grid{grid-template-columns:repeat(2,1fr)} .card{padding:12px} .name{font-size:15px} }
@media (max-width:520px){ .grid{grid-template-columns:1fr} }
</style>
</head>
<body>
<div class="container">
  <header>
    <div style="display:flex;align-items:baseline;gap:8px">
      <h2 style="margin:0;color:var(--gold)">lostamen</h2>
      <span class="small">다중 캐릭터 보드</span>
    </div>
    <div style="margin-left:auto" class="small" id="status">준비됨 · 1시간 자동 갱신</div>
  </header>

  <section class="card top-banner" id="bn-top"></section>

  <div class="main">
    <section class="card" id="chars">
      <div class="controls">
        <button id="refreshAll">전체 갱신</button>
        <span class="small" style="margin-left:auto">정렬: 아이템 레벨(내림차순)</span>
      </div>
      <div id="charGrid" class="grid"></div>
    </section>
  </div>

  <section class="card bottom-banner" id="bn-bottom"></section>
</div>

<!-- 상세 모달 -->
<div id="detailModal" class="modal" aria-modal="true" role="dialog">
  <div class="panel">
    <div class="left">
      <button class="closeX" id="closeDetail" aria-label="닫기">✕</button>
      <img id="dAvatar" alt="avatar" style="width:100%;border-radius:12px;object-fit:cover;aspect-ratio:1/1;background:#061016"/>
      <div style="margin-top:10px">
        <div style="font-weight:900;color:var(--gold)" id="dName">-</div>
        <div class="small" id="dServer">-</div>
        <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap">
          <div class="chip">직업 <span id="dCls">-</span></div>
          <div class="chip">아이템 레벨 <span id="dIlv">-</span></div>
          <div class="chip" id="dCpWrap" style="display:none">전투력 <span id="dCp">-</span></div>
        </div>
      </div>
      <div class="divider"></div>
      <div class="gems" id="dGemSum"></div>
      <div class="divider"></div>
      <div style="font-weight:800;color:var(--gold);margin-bottom:6px">각인</div>
      <div class="engr" id="dEngr"></div>
    </div>

    <div class="right">
      <div style="font-weight:800;color:var(--gold);margin-bottom:6px">장비 상세</div>
      <div class="equip" id="dEquip"></div>
      <div class="divider"></div>
      <div style="font-weight:800;color:var(--gold);margin-bottom:6px">카드</div>
      <div class="cards" id="dCards"></div>
    </div>
  </div>
</div>

<!-- 디버그 버튼/패널 -->
<button id="__dbgBtn" class="small" style="position:fixed;right:12px;bottom:12px;background:#1d2633;border:1px solid rgba(255,255,255,.2);color:#ffd58a;border-radius:10px;padding:8px 10px;cursor:pointer">디버그</button>
<div id="__dbgPanel" class="card" style="position:fixed;right:12px;bottom:52px;width:min(92vw,520px);max-height:60vh;overflow:auto;display:none">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div class="small" style="font-weight:800;color:#ffd58a">API Debug</div>
    <div><button id="__dbgClear" class="small">지우기</button> <button id="__dbgClose" class="small">닫기</button></div>
  </div>
  <pre id="__dbgOut" class="small" style="white-space:pre-wrap"></pre>
</div>

<script>
var ADMIN_CHARACTERS = ['장용노예2호','애이르','오바때끼','우니꼬쏠쏠','미드미네머너','달빛로드','신쿠fr','아장르카용나','데헌장파튀'].slice(0,20);
var API_BASE = 'https://yong-qgw8.vercel.app/api'; // 네 vercel API
var AUTO_MS = 60*60*1000;
var $ = s => document.querySelector(s);

(function(){ // dbg
  var p=$('#__dbgPanel'),o=$('#__dbgOut');
  function t(){return new Date().toLocaleTimeString();}
  window.__dbg=(l,x)=>{ try{ o.textContent="["+t()+"] "+l+"\n"+(typeof x==='string'?x:JSON.stringify(x,null,2)).slice(0,20000)+"\n\n"+o.textContent; }catch{} }
  $('#__dbgBtn').onclick=()=>{ p.style.display = p.style.display==='block'?'none':'block'; };
  $('#__dbgClose').onclick=()=>{ p.style.display='none'; };
  $('#__dbgClear').onclick=()=>{ o.textContent=''; };
})();

function setStatus(t){ var s=$('#status'); if(s) s.textContent=t; }
function parseItemLevel(raw){ if(!raw) return 0; var n=parseFloat(String(raw).replace(/[^0-9.]/g,'')); return isNaN(n)?0:n; }
function esc(s){ return String(s||'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }

function gradeColor(cls){
  return {ancient:'#d4af37',relic:'#f44336',legendary:'#ffa726',epic:'#b388ff',rare:'#64b5f6',uncommon:'#66bb6a',common:'#9aa6b2'}[cls||'common']||'#9aa6b2';
}

async function fetchChar(name){
  var url = API_BASE + '/character?name=' + encodeURIComponent(name) + '&_t=' + Date.now();
  __dbg('REQ '+name, url);
  var r = await fetch(url, {mode:'cors', cache:'no-store'});
  var text = await r.text();
  __dbg('RES '+name+'('+r.status+')', text);
  if(!r.ok) throw new Error('API '+r.status);
  return JSON.parse(text);
}

function renderSkeleton(){
  var html=''; for(var i=0;i<ADMIN_CHARACTERS.length;i++){
    html+='<div class="card-char"><div class="skeleton" style="width:100%;aspect-ratio:1/1;border-radius:12px"></div><div class="skeleton" style="height:16px;border-radius:8px;margin-top:8px"></div><div class="skeleton" style="height:12px;border-radius:6px;margin-top:6px;opacity:.6"></div></div>';
  } $('#charGrid').innerHTML=html;
}
function renderGrid(list){
  var wrap=$('#charGrid'), html='';
  list.forEach(function(it,i){
    var av = it.avatar || 'data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 300"><rect width="300" height="300" fill="#061016"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#9aa6b2" font-size="16">NO IMAGE</text></svg>');
    html += '<div class="card-char" data-idx="'+i+'">'
          +   '<img src="'+av+'" alt="'+esc(it.name)+' 아바타">'
          +   '<div class="name">'+esc(it.name)+'</div>'
          +   '<div class="meta">서버: '+esc(it.server)+'</div>'
          +   '<div class="meta">직업: '+esc(it.cls||'-')+'</div>'
          +   '<div class="row"><span class="small">아이템 레벨</span><strong>'+esc(it.itemLevelText||'-')+'</strong></div>'
          +   '<div class="row"><span class="small">전투력</span><strong>'+(it.combatPower||'-')+'</strong></div>'
          + '</div>';
  });
  wrap.innerHTML=html;
  wrap.querySelectorAll('.card-char').forEach(function(card){
    card.addEventListener('click', function(){
      var idx = Number(card.getAttribute('data-idx')); openDetail(list[idx]);
    });
  });
  setStatus('표시: '+list.length+'개 · 정렬: 아이템 레벨');
}

function pill(text){ return '<span class="gem-pill">'+esc(text)+'</span>'; }

function openDetail(d){
  $('#dAvatar').src = d.avatar || '';
  $('#dName').textContent = d.name;
  $('#dServer').textContent = '서버: '+d.server;
  $('#dCls').textContent = d.cls || '-';
  $('#dIlv')?.textContent = d.itemLevelText || '-';
  if(d.combatPower){ $('#dCpWrap').style.display='inline-flex'; $('#dCp').textContent=d.combatPower; } else $('#dCpWrap').style.display='none';

  // 보석 요약
  var g = d.gems || {};
  var gs = $('#dGemSum'); gs.innerHTML='';
  var parts=[];
  if(g.avgLevel) parts.push('평균 '+g.avgLevel);
  if(g.counts && (g.counts.damage||g.counts.cooldown))
    parts.push((g.counts.damage||0)+'뎀', (g.counts.cooldown||0)+'쿨');
  gs.innerHTML = parts.length? parts.map(pill).join(' ') : '<span class="small">보석 정보 없음</span>';

  // 각인
  var en = $('#dEngr'); en.innerHTML = (d.engraves||[]).length ? '' : '<span class="small">각인 정보 없음</span>';
  (d.engraves||[]).forEach(function(x){ var sp=document.createElement('span'); sp.className='chip'; sp.textContent=x; en.appendChild(sp); });

  var eqWrap = $('#dEquip'); eqWrap.innerHTML = '';
  (d.equipment||[]).forEach(function(e){
    var color = gradeColor(e.gradeClass);
    var enhance = e.meta && e.meta.enhance ? ('+'+e.meta.enhance) : '';
    var upper   = e.meta && e.meta.upper   ? (' x'+e.meta.upper) : '';
    var right = [
      e.meta && e.meta.step ? (e.meta.step+'단계') : '',
      e.meta && e.meta.tier ? e.meta.tier : ''
    ].filter(Boolean).join('<br>');

    var qHtml = (typeof e.quality==='number')
      ? '<div class="qpill">품질 <b>'+e.quality+'</b><div style="height:6px;border-radius:999px;background:rgba(255,255,255,.08);margin-left:8px;flex:1;overflow:hidden"><div style="height:6px;width:'+Math.max(0,Math.min(100,e.quality))+'%;background:linear-gradient(90deg,#3fb950,#f2cc60,#ff6b6b)"></div></div></div>'
      : '';

    var lines = (e.lines||[]).map(function(line){
      var g = line.startsWith('상') ? 'orange' : (line.startsWith('중') ? 'purple' : 'blue');
      var text = line.replace(/^(상|중|하)\s*/, '');
      return '<div class="opt-line"><span class="tag '+g+'">'+line.charAt(0)+'</span><span class="small">'+esc(text)+'</span></div>';
    }).join('');

    var transHtml = '';
    if (e.meta && e.meta.transcend) {
      const t = e.meta.transcend;
      transHtml = '<span class="gem-pill">초월 '+(t.avg?('Lv.'+t.avg):'')+(t.total?(' ×'+t.total):'')+'</span>';
    }
    var elixirHtml = '';
    if (e.meta && e.meta.elixir) {
      const el = e.meta.elixir;
      elixirHtml = '<span class="gem-pill">엘릭서 '+(el.level?'Lv.'+el.level: (el.percent? el.percent+'%':''))+'</span>';
    }

    var row = document.createElement('div');
    row.className='equip-row';
    row.style.borderLeft = '4px solid '+color;
    row.innerHTML =
      '<img src="'+(e.icon||'https://via.placeholder.com/42')+'" alt="" style="width:42px;height:42px;border-radius:8px;object-fit:cover;border:1px solid rgba(255,255,255,.12)">'+
      '<div>'+
        '<div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-bottom:2px">'+
          '<span class="badge" style="color:'+color+'">'+esc(e.grade||'')+'</span>'+
          (enhance? '<span class="badge">'+enhance+(upper?(' '+upper):'')+'</span>':'')+
          '<span style="font-weight:800;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+esc(e.name||'')+'</span>'+
        '</div>'+
        (qHtml? '<div style="display:flex;align-items:center;gap:6px;margin-top:4px">'+qHtml+'</div>':'')+
        '<div style="display:flex;gap:6px;flex-wrap:wrap;margin:6px 0">'+transHtml+elixirHtml+'</div>'+
        '<div class="opt-lines">'+(lines || '<span class="small">부여 옵션 없음</span>')+'</div>'+
      '</div>'+
      '<div class="small" style="text-align:right;min-width:64px">'+right+'</div>';
    eqWrap.appendChild(row);
  });

  // 카드
  var c = d.cards || {}; var cw = $('#dCards'); cw.innerHTML='';
  if ((c.list||[]).length) {
    (c.list||[]).forEach(function(it){
      var slot=document.createElement('div'); slot.className='card-slot';
      slot.innerHTML='<img src="'+(it.icon||'https://via.placeholder.com/68x94')+'" alt="'+esc(it.name||'')+'"><span class="awake">x'+(it.awakening||0)+'</span>';
      cw.appendChild(slot);
    });
    if (c.setName || c.awakeningTotal!=null) {
      var badge=document.createElement('div'); badge.className='small'; badge.style.marginTop='6px';
      badge.textContent = [c.setName? (c.setName+(c.setCount? ' '+c.setCount+'세트':'')) : null, c.awakeningTotal!=null? ('총 '+c.awakeningTotal+'각') : null].filter(Boolean).join(' · ');
      cw.appendChild(badge);
    }
  } else {
    cw.innerHTML = '<span class="small">카드 정보 없음</span>';
  }

  $('#detailModal').classList.add('on');
}

async function refreshAll(){
  try{
    setStatus('전체 불러오는 중...');
    renderSkeleton();
    var results = await Promise.allSettled(ADMIN_CHARACTERS.map(fetchChar));
    var list = results.map((r,i)=> r.status==='fulfilled'? r.value : {name:ADMIN_CHARACTERS[i], server:'-', cls:'-', avatar:'', itemLevelText:'-', combatPower:'-', equipment:[], engraves:[], gems:null, cards:null});
    list.forEach(x => x.itemLevelNum = parseItemLevel(x.itemLevelText));
    list.sort((a,b)=> b.itemLevelNum - a.itemLevelNum);
    renderGrid(list);
    try{ localStorage.setItem('gridCache_v5', JSON.stringify(list)); }catch(_){}
    setStatus('완료');
  }catch(e){
    __dbg('refreshAll ERR', String(e&&e.message||e));
    try{
      var cache=localStorage.getItem('gridCache_v5'); if(cache){ renderGrid(JSON.parse(cache)); setStatus('오프라인 캐시 표시'); return; }
    }catch(_){}
    setStatus('실패: 네트워크/백엔드 점검');
  }
}

document.addEventListener('DOMContentLoaded', function(){
  refreshAll();
  document.getElementById('refreshAll').addEventListener('click', refreshAll);
  document.getElementById('closeDetail').addEventListener('click', function(){ document.getElementById('detailModal').classList.remove('on'); });
  document.getElementById('detailModal').addEventListener('click', function(e){ if(e.target.id==='detailModal') document.getElementById('detailModal').classList.remove('on'); });
});
</script>
</body>
</html>