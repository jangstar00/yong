<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>lostamen — 캐릭터 보드</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1720; --muted:#95a3b3; --gold:#d4af37; --glass:rgba(255,255,255,.04);
      --radius:14px; --radius-sm:10px; --shadow:0 6px 18px rgba(0,0,0,.5);
      --pill:#222c3b; --pill-bd:rgba(255,255,255,.12);
      --q-green:#36c86b; --q-yellow:#e5c04b; --q-red:#ff6b6b;
      --fz-base:14px; --fz-sm:12px; --fz-xs:11px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; padding:clamp(10px, 2.6vw, 20px);
      font-family:'Noto Sans KR',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background:linear-gradient(180deg,#071016 0%, #07131a 60%);
      color:#e8eef6; line-height:1.45; font-size:var(--fz-base);}
    .container{max-width:1000px;margin:0 auto;display:grid;gap:14px}

    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:var(--radius);padding:14px;border:1px solid rgba(255,255,255,0.06);box-shadow:var(--shadow)}
    .small{font-size:var(--fz-sm);color:var(--muted)}
    .xsmall{font-size:var(--fz-xs);color:var(--muted)}
    button{background:transparent;border:1px solid rgba(255,255,255,0.12);padding:8px 12px;border-radius:10px;color:var(--gold);cursor:pointer}
    button:active{transform:translateY(1px)}

    .top-banner,.bottom-banner{background:var(--glass);border-radius:var(--radius-sm);min-height:96px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .top-banner img,.bottom-banner img{width:100%;height:100%;object-fit:cover;display:block}

    /* 좌우 플로팅 배너 */
    .side-float{position:fixed; top:160px; width:300px; z-index:50;}
    .side-float.left{left:16px}
    .side-float.right{right:16px}
    .float-card{background:rgba(0,0,0,.12); border-radius:12px; overflow:hidden}
    .side-float a{display:block; line-height:0}
    .side-float img{display:block; width:100%; height:auto; object-fit:cover}
    .mini-stack{margin-top:12px; display:grid; gap:10px}
    .mini{border-radius:12px; overflow:hidden; border:1px solid rgba(255,255,255,.12); background:rgba(0,0,0,.12)}
    .mini img{width:100%; height:86px; object-fit:cover; display:block}
    @media (max-width:1200px){ .side-float{display:none} }

    .controls{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .card-char{background:var(--panel);border-radius:var(--radius);padding:10px;display:flex;flex-direction:column;cursor:pointer;transition:transform .15s ease, box-shadow .15s ease}
    .card-char:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(0,0,0,.5)}
    .card-char img{width:100%;aspect-ratio:1/1;border-radius:10px;object-fit:cover;background:#061016}
    .name{margin:6px 0 2px;font-weight:900;color:var(--gold);font-size:15px}
    .meta{font-size:var(--fz-xs);color:var(--muted)}
    .row{display:flex;justify-content:space-between;margin-top:4px;font-size:var(--fz-sm)}

    /* 모달 */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:12px;z-index:9999}
    .modal.on{display:flex}
    .panel{max-width:1040px;width:100%;background:#0e141c;border:1px solid rgba(255,255,255,.08);border-radius:16px;display:grid;grid-template-columns:340px 1fr;max-height:90vh;overflow:auto}

    .pill{display:inline-flex;align-items:center;gap:6px;background:var(--pill);border:1px solid var(--pill-bd);border-radius:999px;padding:2px 8px;font-size:var(--fz-xs)}
    .chip{background:linear-gradient(90deg, rgba(212,175,55,.16), transparent);padding:2px 8px;border-radius:999px;color:#d4af37;font-weight:800;font-size:var(--fz-xs)}

    .detail-left h4{margin:8px 0 6px;color:var(--gold);font-size:13px}
    .engr-box{min-height:96px;background:#0b121a;border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px;display:flex;flex-wrap:wrap;gap:6px;align-content:flex-start}

    .tiny-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .tiny-row img{width:36px;height:36px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,.12)}
    .gem-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:6px 0;border-top:1px dashed rgba(255,255,255,.12)}
    .gem{display:flex;flex-direction:column;align-items:center;gap:2px}
    .gem img{width:26px;height:26px;object-fit:cover;border-radius:6px;border:1px solid rgba(255,255,255,.12)}
    .cards-row{display:flex;gap:8px;flex-wrap:wrap}
    .cards-row .card-item{width:60px}
    .cards-row .card-item img{width:60px;height:82px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,.12)}
    .cards-row .card-item .xsmall{display:block;text-align:center;margin-top:2px}

    /* 오른쪽 2열(장비/악세사리) */
    .right-wrap{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .section-title{font-weight:800;color:var(--gold);margin-bottom:6px;font-size:13px}

    .equip-grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    .equip-card{display:grid;grid-template-columns:40px 1fr;gap:8px;align-items:start;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:8px;min-height:54px}
    .equip-card img{width:40px;height:40px;border-radius:8px;object-fit:cover;border:1px solid rgba(255,255,255,.12)}
    .equip-title{display:flex;gap:6px;align-items:center;flex-wrap:wrap;font-size:13px}
    .equip-meta{display:flex;gap:6px;flex-wrap:wrap;margin-top:2px}
    .qbar{height:6px;border-radius:6px;background:rgba(255,255,255,.08);overflow:hidden}
    .qbar>i{display:block;height:6px;width:0}
    .q-badge{font-size:var(--fz-xs);color:#eaeaea}

    /* 유효 옵션 뱃지 */
    .badges{display:flex;gap:4px;flex-wrap:wrap;margin-top:6px}
    .badge{display:inline-flex;gap:4px;align-items:center;padding:2px 6px;border-radius:999px;border:1px solid rgba(255,255,255,.12);font-size:10.5px}
    .b-high{background:rgba(255,173,80,.14);color:#ffd29a}
    .b-mid{background:rgba(162,128,255,.16);color:#cdbaff}
    .b-low{background:rgba(77,171,245,.14);color:#a7d8ff}

    @media (max-width:1100px){ .panel{grid-template-columns:1fr} .right-wrap{grid-template-columns:1fr} }
    @media (max-width:720px){ .equip-grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div style="display:flex;align-items:baseline;gap:8px">
        <h2 style="margin:0;color:var(--gold);font-size:18px">lostamen</h2>
        <span class="small">다중 캐릭터 보드</span>
      </div>
      <div style="margin-left:auto" class="small" id="status">준비됨 · 1시간 자동 갱신</div>
    </header>

    <!-- 상단/하단 배너 -->
    <section class="card top-banner" id="bn-top"></section>

    <!-- 메인 그리드 -->
    <section class="card" id="chars">
      <div class="controls">
        <button id="refreshAll">전체 갱신</button>
        <span class="small" style="margin-left:auto">정렬: 아이템 레벨(내림차순)</span>
      </div>
      <div id="charGrid" class="grid"></div>
    </section>

    <section class="card bottom-banner" id="bn-bottom"></section>
  </div>

  <!-- 좌우 플로팅 배너 -->
  <div id="float-left"  class="side-float left"  style="display:none">
    <div class="float-card" id="float-left-main"></div>
  </div>
  <div id="float-right" class="side-float right" style="display:none">
    <div class="float-card" id="float-right-main"></div>
    <div class="mini-stack" id="float-right-minis" style="display:none"></div>
  </div>

  <!-- 상세 모달 -->
  <div id="detailModal" class="modal" aria-modal="true" role="dialog">
    <div class="panel">
      <!-- LEFT -->
      <div class="left detail-left" style="padding:12px;border-right:1px solid rgba(255,255,255,.06)">
        <button id="closeDetail" style="position:sticky;left:100%;top:8px;background:transparent;border:0;color:#cfd8e3;font-size:20px;cursor:pointer">✕</button>
        <img id="dAvatar" alt="avatar" style="width:100%;border-radius:10px;object-fit:cover;aspect-ratio:1/1;background:#061016"/>
        <div style="margin-top:8px">
          <div style="font-weight:900;color:var(--gold);font-size:16px" id="dName">-</div>
          <div class="xsmall" id="dServer">-</div>
          <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap">
            <div class="pill">직업 <span id="dCls" style="margin-left:4px">-</span></div>
            <div class="pill">아이템 레벨 <span id="dIlv" style="margin-left:4px">-</span></div>
            <div class="pill" id="dCpWrap" style="display:none">전투력 <span id="dCp" style="margin-left:4px">-</span></div>
          </div>

          <h4>각인</h4>
          <div id="engrBox" class="engr-box"></div>

          <div style="height:6px"></div>
          <div id="trackWrap">
            <div style="display:flex;gap:6px;align-items:center;flex-wrap:wrap;margin-bottom:4px">
              <span class="pill">진화 <b id="evoVal" class="xsmall" style="margin-left:4px">-</b></span>
              <span class="pill">깨달음 <b id="awakVal" class="xsmall" style="margin-left:4px">-</b></span>
              <span class="pill">도약 <b id="leapVal" class="xsmall" style="margin-left:4px">-</b></span>
            </div>
          </div>

          <div style="height:8px"></div>
          <div style="font-weight:800;color:var(--gold);margin:6px 0 6px;font-size:13px">보석</div>
          <div class="gem-row" id="gemRow"></div>

          <div style="font-weight:800;color:var(--gold);margin:6px 0 6px;font-size:13px">카드</div>
          <div id="cardsRow" class="cards-row"></div>

          <div style="height:6px"></div>
          <div class="tiny-row" id="trinketsRow" title="부적 · 나침반 · 문장"></div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="right" style="padding:12px">
        <div class="right-wrap">
          <div>
            <div class="section-title">장비</div>
            <div id="equipListL" class="equip-grid"></div>
          </div>
          <div>
            <div class="section-title">악세사리</div>
            <div id="equipListR" class="equip-grid"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 디버그 -->
  <button id="__dbgBtn" class="debug-btn" style="position:fixed;right:12px;bottom:12px;background:#1d2633;border:1px solid rgba(255,255,255,.2);color:#ffd58a;border-radius:10px;padding:6px 8px;font-size:12px;cursor:pointer">디버그</button>
  <div id="__dbgPanel" class="debug-panel" style="display:none;position:fixed;right:12px;bottom:44px;z-index:99999;width:min(92vw,520px);max-height:60vh;overflow:auto;background:#0c121a;border:1px solid rgba(255,255,255,.25);border-radius:10px">
    <pre id="__dbgOut" style="margin:0;padding:8px;white-space:pre-wrap;word-break:break-all;font-size:12px;color:#cfe1ff"></pre>
  </div>

  <script>
    /* ===== 설정 ===== */
    const ADMIN_CHARACTERS = ['장용노예2호','애이르','오바때끼','우니꼬쏠쏠','미드미네머너','달빛로드','신쿠fr','아장르카용나','데헌장파튀'].slice(0,20);
    const ADMIN_BANNERS = {
      top:{img:'https://jangstar00.github.io/yong/images/topbaner_tech.png',link:'https://lostark.game.onstove.com/Class?detail=scouter'},
      left:{img:'https://jangstar00.github.io/yong/images/leftbaner_tech.png',link:'https://lostark.game.onstove.com/Class?detail=scouter'},
      right:{img:'https://jangstar00.github.io/yong/images/rightbaner_mj2.png',link:'https://lostark.game.onstove.com/Class?detail=scouter'},
      /* 작은 배너 3개: 필요 없으면 배열 비워두면 됨 */
      smallRight:[
        {img:'https://jangstar00.github.io/yong/images/lostark.png', link:'https://lostark.game.onstove.com/Main'},
        {img:'https://jangstar00.github.io/yong/images/lostbuild.png', link:'https://https://lostbuilds.com/'},
        {img:'https://jangstar00.github.io/yong/images/kloa.png', link:'https://kloa.gg/'}
      ],
      bottom:{img:'https://jangstar00.github.io/yong/images/topbaner_mj.png',link:'https://kloa.gg/characters/%EC%95%A0%EC%9D%B4%EB%A5%B4'}
    };
    const API_BASE = 'https://yong-qgw8.vercel.app/api';
    const AUTO_MS = 60*60*1000;
    const $ = s=>document.querySelector(s);

    /* ===== 디버그 ===== */
    (function(){ let panel=null,out=null,btn=null; const ts=()=>new Date().toLocaleTimeString(); const cut=s=>String(s||'').slice(0,20000);
      window.__dbg=(label,obj)=>{ panel=panel||$('#__dbgPanel'); out=out||$('#__dbgOut'); btn=btn||$('#__dbgBtn');
        if(btn && !btn.__bind){btn.__bind=true; btn.addEventListener('click',()=>{panel.style.display=panel.style.display==='block'?'none':'block';});}
        let j; try{ j=typeof obj==='string'?obj:JSON.stringify(obj,null,2);}catch{ j=String(obj); }
        out.textContent=`[${ts()}] ${label}\n${cut(j)}\n\n`+out.textContent; };
    })();

    /* ===== 배너 ===== */
    function injectMainBanner(containerId, cfg){
      const wrap=document.getElementById(containerId);
      wrap.innerHTML='';
      if(cfg && cfg.img){
        const a=document.createElement('a'); a.href=cfg.link||'#'; a.target='_blank'; a.rel='noopener';
        const img=new Image(); img.src=cfg.img; img.alt=containerId;
        img.onerror=()=>{ wrap.innerHTML='<div class="small" style="padding:8px">배너 로드 실패</div>'; };
        a.appendChild(img); wrap.appendChild(a);
      }else{
        wrap.innerHTML='<div class="small" style="padding:8px">배너 미지정</div>';
      }
    }
    function loadBanners(){
      // 상단/하단
      injectMainBanner('bn-top', ADMIN_BANNERS.top);
      injectMainBanner('bn-bottom', ADMIN_BANNERS.bottom);

      // 좌
      const L=document.getElementById('float-left'); const LM=document.getElementById('float-left-main');
      if(ADMIN_BANNERS.left && ADMIN_BANNERS.left.img){
        L.style.display='block';
        LM.innerHTML='';
        const a=document.createElement('a'); a.href=ADMIN_BANNERS.left.link||'#'; a.target='_blank'; a.rel='noopener';
        const img=new Image(); img.src=ADMIN_BANNERS.left.img; img.alt='left';
        img.onerror=()=>{ LM.innerHTML='<div class="small" style="padding:8px">배너 로드 실패</div>'; };
        a.appendChild(img); LM.appendChild(a);
      }else{ L.style.display='none'; }

      // 우: 메인 + 미니 3개
      const R=document.getElementById('float-right');
      const RM=document.getElementById('float-right-main');
      const RS=document.getElementById('float-right-minis');
      let showRight=false;

      RM.innerHTML='';
      if(ADMIN_BANNERS.right && ADMIN_BANNERS.right.img){
        const a=document.createElement('a'); a.href=ADMIN_BANNERS.right.link||'#'; a.target='_blank'; a.rel='noopener';
        const img=new Image(); img.src=ADMIN_BANNERS.right.img; img.alt='right';
        img.onerror=()=>{ RM.innerHTML='<div class="small" style="padding:8px">배너 로드 실패</div>'; };
        a.appendChild(img); RM.appendChild(a);
        showRight=true;
      }

      RS.innerHTML='';
      const minis=Array.isArray(ADMIN_BANNERS.smallRight)? ADMIN_BANNERS.smallRight.slice(0,3) : [];
      if(minis.length){
        RS.style.display='grid';
        minis.forEach((m,i)=>{
          const box=document.createElement('div'); box.className='mini';
          const a=document.createElement('a'); a.href=m.link||'#'; a.target='_blank'; a.rel='noopener';
          const img=new Image(); img.src=m.img; img.alt='mini-'+(i+1);
          img.onerror=()=>{ box.innerHTML='<div class="small" style="padding:8px">미니 배너 실패</div>'; };
          a.appendChild(img); box.appendChild(a); RS.appendChild(box);
        });
        showRight=true;
      }else{
        RS.style.display='none';
      }
      R.style.display = showRight? 'block':'none';
    }

    /* ===== 유틸 ===== */
    const setStatus=t=>$('#status').textContent=t;
    const esc=s=>String(s||'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
    const strip=s=>String(s||'').replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim();
    const fmtNum=n=>{
      if(n==null||n==='-') return '-';
      const v=(typeof n==='number')?n:Number(String(n).replace(/[^0-9.-]/g,''));
      return Number.isFinite(v)? v.toLocaleString() : String(n);
    };
    const gradeColorByName=g=>{
      g=String(g||''); if(/고대/.test(g))return'#d4af37'; if(/유물/.test(g))return'#f44336';
      if(/전설/.test(g))return'#ffa726'; if(/영웅/.test(g))return'#b388ff'; if(/희귀/.test(g))return'#64b5f6';
      if(/고급/.test(g))return'#66bb6a'; return'#9aa6b2';
    };

    function flattenTooltip(raw){
      if(!raw) return [];
      let j={}; try{ j=JSON.parse(String(raw).replace(/\\"/g,'"')); }catch(_){ return String(raw).split(/\n/); }
      const parts=[];
      const dive=v=>{
        if(!v) return;
        if(typeof v==='string'){ parts.push(v); return; }
        if(Array.isArray(v)){ v.forEach(dive); return; }
        if(typeof v==='object'){
          if(v.contentStr) dive(v.contentStr);
          if(v.leftStr) dive(v.leftStr);
          if(v.rightStr) dive(v.rightStr);
          if(v.topStr) dive(v.topStr);
          if(v.value) dive(v.value);
          Object.keys(v).forEach(k=>{ if(/^Element_\d+/.test(k)) dive(v[k]); });
        }
      };
      Object.keys(j).forEach(k=>dive(j[k]));
      return parts
        .join('\n')
        .split(/\n|<br>|<BR>/i)
        .map(s=>strip(String(s).replace(/&nbsp;/g,' ')))
        .filter(Boolean);
    }
    function extractAffixOptions(tooltipRaw){
      return flattenTooltip(tooltipRaw)
        .filter(s=>/^(상|중|하)\s/.test(s))
        .map(s=>({ rank:s[0], text:s.replace(/^(상|중|하)\s*/,'').trim() }));
    }
    function parseAccessoryDetails(tooltip){
      const L=flattenTooltip(tooltip);
      const J=L.join(' ');
      const ilv=(J.match(/아이템\s*레벨\s*([0-9,]+)/i)||[])[1];
      const tier=(J.match(/티어\s*([0-9])/i)||[])[1];
      const q=(J.match(/품질\s*([0-9]{1,3}(?:\.[0-9]+)?)/i)||[])[1];
      const options=L.filter(s=>/^(상|중|하)\s/.test(s)).map(s=>({rank:s[0], text:s.replace(/^(상|중|하)\s*/,'')}));
      return {itemLevel:ilv?Number(ilv.replace(/,/g,'')):null, tier:tier?Number(tier):null, quality:q?Number(q):null, options};
    }
    function parseMeta(tooltip, name, grade){
      const L=flattenTooltip(tooltip);
      const plain=L.join(' ')+' '+(name||' ')+' '+(grade||' ');
      const enhance=(plain.match(/\+\s*(\d{1,2})\b/)||[])[1];
      const upperX=(plain.match(/x\s*(\d{1,2})\b/i)||[])[1];
      const upperStage=(plain.replace(/<[^>]+>/g,' ').match(/상급\s*재련[^0-9]*([0-9]{1,2})\s*단계/i)||[])[1];
      const step=(plain.match(/(\d{1,2})\s*단계/i)||[])[1];
      const tier=(plain.match(/티어\s*([0-9])/i)||[])[1];
      return { enhance:enhance?Number(enhance):null, upper: upperX?Number(upperX): (upperStage?Number(upperStage):null), step: step?Number(step):null, tier: tier?('T'+tier):null };
    }

    /* ===== API ===== */
    async function fetchChar(name){
      const url = API_BASE + '/character?name=' + encodeURIComponent(name) + '&_t=' + Date.now();
      try{
        __dbg('REQ '+name, url);
        const res = await fetch(url, { mode:'cors', cache:'no-store' }); const text = await res.text();
        __dbg('RES '+name+' ('+res.status+')', text);
        if(!res.ok) throw new Error('API '+res.status+' '+text);
        const raw = JSON.parse(text); const d = raw.data || raw;

        return mapArmory({
          ArmoryProfile:{ CharacterName:d.name, ServerName:d.server, CharacterClassName:d.cls, CharacterImage:d.avatar, ItemMaxLevel:d.itemLevelText, Stats:d.stats },
          ArmoryEquipment:d.equipment,
          ArmoryEngraving:{ Engravings:(d.engraves||[]).map(s=>{ const m=String(s).match(/^(.+?)\s*Lv\.\s*([0-9]+)/); return {Name:m?m[1]:s,Level:m?Number(m[2]):null}; }) },
          _cards:d.cards,_gems:d.gems,_combatPower:d.combatPower,_tracks:d.tracks||d.progress||null
        });
      }catch(e){ __dbg('ERR '+name, String(e.message||e)); return mockChar(name); }
    }
    function mapArmory(raw){
      raw=raw||{}; const p=raw.ArmoryProfile||{}; const equips=raw.ArmoryEquipment||[];
      const engrs=(raw.ArmoryEngraving&&raw.ArmoryEngraving.Engravings||[]).map(e=>(e?.Name||'')+(e?.Level?(' Lv.'+e.Level):'')).filter(Boolean);
      const itemLevelText=p.ItemMaxLevel||p.ItemAvgLevel||p.ItemLevel||'-';
      const itemLevelNum=parseFloat(String(itemLevelText).replace(/[^0-9.]/g,''))||0;

      return {
        name:p.CharacterName||'-', server:p.ServerName||'-', cls:p.CharacterClassName||'-', avatar:p.CharacterImage||'',
        itemLevelText, itemLevelNum,
        combatPower:(raw._combatPower!=null)? raw._combatPower : '-',
        stats:Array.isArray(p.Stats)? p.Stats:[],
        equipment:(equips||[]).map(x=>{
          x=x||{};
          const nm=x.Name||'', gr=x.Grade||'', tp=x.Tooltip||'', ic=x.Icon||'';
          const qAny = (x.Quality ?? x.quality ?? x.qualityValue ?? x.QualityValue ?? null);
          const quality = (qAny!=null) ? Number(qAny) : null;
          const tstr=String(x.Type||x.Slot||'')+' '+nm;
          const isAcc=/(목걸이|귀걸이|반지|어빌리티\s*스톤|스톤|팔찌)/.test(tstr);
          return {
            type:x.Type||x.Slot||'',
            name:nm, grade:gr, icon:ic,
            quality: Number.isFinite(quality)? quality : null,
            tooltip:tp,
            opt: extractAffixOptions(tp),
            meta: parseMeta(tp,nm,gr),
            acc: isAcc? parseAccessoryDetails(tp) : null
          };
        }),
        engraves:engrs,
        cards:raw._cards||null, gems:raw._gems||null,
        tracks:raw._tracks||null
      };
    }
    function mockChar(name){ const ilv=1500+Math.floor(Math.random()*300); return {name,server:'-',cls:'-',avatar:'',itemLevelText:ilv.toFixed(2),itemLevelNum:ilv,combatPower:'-',stats:[],equipment:[],engraves:[],cards:null,gems:null,tracks:null}; }

    /* ===== GRID ===== */
    function renderSkeleton(){
      const wrap=$('#charGrid'); wrap.innerHTML='';
      ADMIN_CHARACTERS.forEach(()=>{ wrap.innerHTML+=`
        <div class="card-char">
          <div style="width:100%;aspect-ratio:1/1;border-radius:10px;background:linear-gradient(90deg, rgba(255,255,255,.06), transparent)"></div>
          <div style="height:14px;border-radius:8px;margin-top:6px;background:rgba(255,255,255,.06)"></div>
          <div style="height:10px;border-radius:6px;margin-top:4px;background:rgba(255,255,255,.06);opacity:.6"></div>
        </div>`; });
    }
    function renderGrid(list){
      const wrap=$('#charGrid'); wrap.innerHTML='';
      list.sort((a,b)=>(b.itemLevelNum||0)-(a.itemLevelNum||0));
      list.forEach((it)=>{
        const avatar=it.avatar||'data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 300"><rect width="300" height="300" fill="#061016"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#9aa6b2" font-size="16">NO IMAGE</text></svg>');
        const card=document.createElement('div'); card.className='card-char';
        card.innerHTML=`
          <img src="${avatar}" alt="${esc(it.name)} 아바타">
          <b class="name">${esc(it.name)}</b>
          <div class="meta">서버: ${esc(it.server)}</div>
          <div class="meta">직업: ${esc(it.cls||'-')}</div>
          <div class="row"><span class="xsmall">아이템 레벨</span><strong style="font-size:13px">${esc(it.itemLevelText||'-')}</strong></div>
          <div class="row"><span class="xsmall">전투력</span><strong style="font-size:13px">${fmtNum(it.combatPower)}</strong></div>`;
        card.addEventListener('click',()=>openDetail(it));
        wrap.appendChild(card);
      });
      setStatus(`표시: ${list.length}개 · 정렬: 아이템 레벨`);
    }

    /* ===== DETAIL ===== */
    function openDetail(d){
      $('#dAvatar').src=d.avatar||'';
      $('#dName').textContent=d.name;
      $('#dServer').textContent='서버: '+(d.server||'-');
      $('#dCls').textContent=d.cls||'-';
      $('#dIlv').textContent=d.itemLevelText||'-';
      if(d.combatPower && d.combatPower!=='-'){ $('#dCpWrap').style.display='inline-flex'; $('#dCp').textContent=fmtNum(d.combatPower); }
      else $('#dCpWrap').style.display='none';

      // 각인
      const engr=d.engraves||[]; const engrBox=$('#engrBox'); engrBox.innerHTML='';
      if(!engr.length) engrBox.innerHTML='<span class="xsmall">각인 정보 없음</span>';
      else engr.forEach(x=>{ const sp=document.createElement('span'); sp.className='chip'; sp.textContent=x; engrBox.appendChild(sp); });

      // 트랙
      const tr=d.tracks||{}; $('#evoVal').textContent = tr.evolution!=null? tr.evolution : '-';
      $('#awakVal').textContent = tr.awakening!=null? tr.awakening : '-';
      $('#leapVal').textContent = tr.leap!=null? tr.leap : '-';

      // 분류
      const list=d.equipment||[];
      const leftSlots=/무기|투구|모자|상의|하의|장갑|어깨/;
      const rightSlots=/목걸이|귀걸이|반지|스톤|어빌리티\s*스톤|팔찌/;
      const trinketSlots=/부적|나침반|문장/;

      const left=list.filter(e=>leftSlots.test(e.type+' '+e.name));
      const right=list.filter(e=>rightSlots.test(e.type+' '+e.name));
      const trinkets=list.filter(e=>trinketSlots.test(e.type+' '+e.name));

      // 소형 아이콘 (맨 아래)
      const triRow=$('#trinketsRow'); triRow.innerHTML='';
      trinkets.forEach(t=>{ const img=document.createElement('img'); img.src=t.icon||'https://via.placeholder.com/36'; img.alt=''; img.title=t.name||''; triRow.appendChild(img); });

      // 정렬
      const slotOrder=s=>{
        if(/무기/.test(s)) return 0; if(/투구|모자/.test(s)) return 1; if(/상의/.test(s)) return 2;
        if(/하의/.test(s)) return 3; if(/장갑/.test(s)) return 4; if(/어깨/.test(s)) return 5;
        if(/목걸이/.test(s)) return 10; if(/귀걸이/.test(s)) return 11; if(/반지/.test(s)) return 12;
        if(/스톤|어빌리티/.test(s)) return 13; if(/팔찌/.test(s)) return 14; return 99;
      };
      left.sort((a,b)=>slotOrder(a.type+a.name)-slotOrder(b.type+b.name));
      right.sort((a,b)=>slotOrder(a.type+a.name)-slotOrder(b.type+b.name));

      const wrapL=$('#equipListL'); const wrapR=$('#equipListR');
      wrapL.innerHTML=''; wrapR.innerHTML='';

      const pct=x=>Math.max(0,Math.min(100,Number(x)||0));
      const makeBadges=(opts)=>{
        if(!opts||!opts.length) return '';
        const pills = opts.map(o=>{
          const cls = o.rank==='상'?'b-high':(o.rank==='중'?'b-mid':'b-low');
          return `<span class="badge ${cls}">${o.rank} ${o.text?esc(o.text):''}</span>`;
        }).join('');
        return `<div class="badges">${pills}</div>`;
      };

      function equipCard(e, isAccessory){
        const card=document.createElement('div'); card.className='equip-card';
        const icon=document.createElement('img'); icon.src=e.icon||'https://via.placeholder.com/40'; icon.alt='';
        const mid=document.createElement('div');

        const metaBits=[];
        if(e.meta && (e.meta.enhance||e.meta.upper||e.meta.step)){
          if(e.meta.enhance) metaBits.push('+'+e.meta.enhance);
          if(e.meta.upper) metaBits.push('상재련 '+e.meta.upper);
          else if(e.meta.step) metaBits.push(e.meta.step+'단');
        }
        const title=document.createElement('div'); title.className='equip-title';
        title.innerHTML = `<span class="xsmall" style="color:${gradeColorByName(e.grade)}">${esc(e.grade||'')}</span>
                           <b style="font-size:13px">${esc(e.name||'')}</b>
                           ${metaBits.length? `<span class="pill">${metaBits.join(' · ')}</span>`:''}`;
        mid.appendChild(title);

        const acc=e.acc;
        const qsrc = (acc && typeof acc.quality==='number') ? acc.quality : (typeof e.quality==='number'? e.quality : null);
        const infoBits=[];
        if(qsrc!=null) infoBits.push('품질 '+qsrc);
        if(acc && acc.itemLevel) infoBits.push('Lv.'+acc.itemLevel);
        if(acc && acc.tier) infoBits.push('T'+acc.tier);
        if(infoBits.length){
          const meta=document.createElement('div'); meta.className='equip-meta';
          meta.innerHTML = infoBits.map(t=>`<span class="pill">${esc(t)}</span>`).join(' ');
          mid.appendChild(meta);
        }
        if(qsrc!=null){
          const qwrap=document.createElement('div'); qwrap.style.marginTop='4px';
          qwrap.innerHTML=`<div class="qbar"><i style="width:${pct(qsrc)}%;background:linear-gradient(90deg,var(--q-green),var(--q-yellow),var(--q-red))"></i></div>`;
          mid.appendChild(qwrap);
        }

        if(isAccessory){
          const opts = (acc && acc.options && acc.options.length) ? acc.options : e.opt;
          if(opts && opts.length){
            const html = makeBadges(opts.slice(0,4));
            const optDiv=document.createElement('div'); optDiv.innerHTML=html; mid.appendChild(optDiv);
          }
        }

        card.appendChild(icon); card.appendChild(mid);
        return card;
      }

      left.forEach(e=>wrapL.appendChild(equipCard(e, false)));
      right.forEach(e=>wrapR.appendChild(equipCard(e, true)));

      // 보석
      const gemRow=$('#gemRow'); gemRow.innerHTML='';
      const g=d.gems||{}; const items=(g.list&&Array.isArray(g.list))?g.list:(g.items&&Array.isArray(g.items))?g.items:[];
      const fallback='https://jangstar00.github.io/yong/images/gem_default.png';
      if(items.length){
        items.forEach(it=>{
          const div=document.createElement('div'); div.className='gem';
          const img=document.createElement('img'); img.src=it.icon||fallback; img.alt='';
          const cap=document.createElement('span'); cap.className='xsmall'; cap.textContent = it.level?('Lv.'+it.level):'';
          div.appendChild(img); div.appendChild(cap); gemRow.appendChild(div);
        });
      }else{
        for(let i=0;i<11;i++){ const div=document.createElement('div'); div.className='gem';
          const img=document.createElement('img'); img.src=fallback; img.alt=''; div.appendChild(img);
          div.appendChild(Object.assign(document.createElement('span'),{className:'xsmall',textContent:''}));
          gemRow.appendChild(div);
        }
      }
      if(g.avgLevel){ const info=document.createElement('span'); info.className='xsmall'; info.style.marginLeft='6px'; info.textContent='평균 Lv. '+g.avgLevel; gemRow.appendChild(info); }

      // 카드
      const cardsRow=$('#cardsRow'); cardsRow.innerHTML='';
      const cs=d.cards||{}; if((cs.list||[]).length){
        cs.list.forEach(it=>{ const c=document.createElement('div'); c.className='card-item';
          c.innerHTML=`<img src="${it.icon||'https://via.placeholder.com/60x82'}"><span class="xsmall">x${it.awakening||0}</span>`; cardsRow.appendChild(c); });
      }else cardsRow.innerHTML='<span class="xsmall">카드 정보 없음</span>';

      $('#detailModal').classList.add('on');
    }

    /* ===== 데이터 흐름 ===== */
    async function refreshAll(){
      try{
        setStatus(navigator.onLine? '전체 불러오는 중...' : '오프라인: 캐시/모의 데이터 표시');
        renderSkeleton();
        const results = await Promise.allSettled(ADMIN_CHARACTERS.map(fetchChar));
        const list = results.map((r,i)=> r.status==='fulfilled'? r.value : mockChar(ADMIN_CHARACTERS[i]));
        renderGrid(list);
        try{ localStorage.setItem('gridCache_v22', JSON.stringify(list)); }catch(_){}
        setStatus('완료');
      }catch(err){
        __dbg('refreshAll ERR', String(err && err.message || err));
        try{ const cache = localStorage.getItem('gridCache_v22'); if(cache){ renderGrid(JSON.parse(cache)); setStatus('오프라인 캐시 표시'); return; } }catch(_){}
        renderGrid(ADMIN_CHARACTERS.map(mockChar)); setStatus('네트워크 실패: 모의 데이터 표시');
      }
    }

    /* ===== 초기화 ===== */
    document.addEventListener('DOMContentLoaded', ()=>{
      loadBanners();
      refreshAll();
      $('#refreshAll').addEventListener('click', refreshAll);
      $('#closeDetail').addEventListener('click', ()=>$('#detailModal').classList.remove('on'));
      $('#detailModal').addEventListener('click', e=>{ if(e.target.id==='detailModal') $('#detailModal').classList.remove('on'); });
      setInterval(refreshAll, AUTO_MS);
      window.addEventListener('online', ()=>{ setStatus('온라인 복구: 재동기화 중...'); refreshAll(); });
      window.addEventListener('offline', ()=>setStatus('오프라인: 캐시/모의 데이터 표시'));
    });
  </script>
</body>
</html>
