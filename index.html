<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>lostamen — 캐릭터 보드</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0f14; --panel:#0f1720; --muted:#9aa6b2; --gold:#d4af37; --glass:rgba(255,255,255,0.04);
      --radius:16px; --radius-sm:12px; --shadow:0 6px 18px rgba(0,0,0,.5);
      --chip:#1b2432;
      --acc-hi:#ffb86b; --acc-mid:#c4b5fd; --acc-low:#93c5fd; --acc-neutral:#cbd5e1;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; padding:clamp(10px, 2.8vw, 22px);
      font-family:'Noto Sans KR',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
      background:linear-gradient(180deg,#071016 0%, #07131a 60%);
      color:#e6eef6; line-height:1.55;
    }
    .container{max-width:1200px;margin:0 auto;display:grid;gap:16px}

    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:var(--radius);padding:16px;border:1px solid rgba(255,255,255,0.06);box-shadow:var(--shadow)}
    .small{font-size:12px;color:var(--muted)}
    button{background:transparent;border:1px solid rgba(255,255,255,0.12);padding:10px 14px;border-radius:12px;color:var(--gold);cursor:pointer}
    button:active{transform:translateY(1px)}

    .top-banner,.bottom-banner{background:var(--glass);border-radius:var(--radius-sm);min-height:110px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .top-banner img,.bottom-banner img{width:100%;height:100%;object-fit:cover;display:block}

    /* 사이드 배너 (데스크톱만) */
    .side-float{position:fixed; top:160px; width:300px; z-index:50; background:rgba(0,0,0,.12); border-radius:12px; overflow:hidden}
    .side-float.left{left:16px}
    .side-float.right{right:16px}
    .side-float a{display:block; line-height:0}
    .side-float img{display:block; width:100%; height:auto; object-fit:cover}
    .side-mini{display:grid; gap:10px; margin-top:10px; padding:10px}
    .side-mini a{display:block; border-radius:10px; overflow:hidden; border:1px solid rgba(255,255,255,.15)}
    .side-mini img{display:block; width:100%; height:auto}

    .main{display:grid;grid-template-columns:1fr;gap:16px}

    /* 그리드 */
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    .card-char{background:var(--panel);border-radius:var(--radius);padding:12px;display:flex;flex-direction:column;align-items:stretch;cursor:pointer;transition:transform .15s ease, box-shadow .15s ease}
    .card-char:hover{transform:translateY(-2px);box-shadow:0 10px 24px rgba(0,0,0,.5)}
    .card-char img{width:100%;aspect-ratio:1/1;border-radius:12px;object-fit:cover;background:#061016}
    .name{margin:8px 0 2px;font-weight:900;color:var(--gold)}
    .meta{font-size:12px;color:var(--muted)}
    .row{display:flex;justify-content:space-between;margin-top:6px}

    /* 상세 모달 */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:14px;z-index:9999}
    .modal.on{display:flex}
    .panel{max-width:1100px;width:100%;background:#0e141c;border:1px solid rgba(255,255,255,.08);border-radius:16px;display:grid;grid-template-columns:320px 1fr;max-height:90vh;overflow:auto}
    .panel .left{padding:14px;border-right:1px solid rgba(255,255,255,.06)}
    .panel .right{padding:14px}
    .closeX{position:sticky;left:100%;top:10px;background:transparent;border:0;color:#cfd8e3;font-size:22px;cursor:pointer}

    .hero{width:100%;aspect-ratio:1/1;border-radius:12px;object-fit:cover;background:#061016}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .chip{background:#1b2432;padding:4px 8px;border-radius:999px;color:#d4af37;font-weight:800;font-size:12px;border:1px solid rgba(255,255,255,.09)}

    /* 상세 본문 레이아웃 */
    .detail-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .section{background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:12px}
    .section h4{margin:0 0 8px;font-size:14px;color:var(--gold)}

    .itemRow{display:grid;grid-template-columns:42px 1fr auto;gap:10px;align-items:center;padding:8px;border-radius:10px;background:rgba(255,255,255,.03);border:1px solid rgba(255,255,255,.05);margin-bottom:8px}
    .itemRow .icon{width:42px;height:42px;border-radius:8px;object-fit:cover;background:#061016}
    .itemRow .title{font-size:13px;font-weight:800}
    .qBadge{padding:2px 8px;border-radius:999px;font-size:11px;border:1px solid rgba(255,255,255,.15)}
    .qBadge.good{color:#0ea5e9;border-color:#0ea5e9}
    .qBadge.mid{color:#f59e0b;border-color:#f59e0b}
    .qBadge.bad{color:#ef4444;border-color:#ef4444}

    .optLine{display:flex;align-items:flex-start;gap:8px;margin-top:4px}
    .tag{display:inline-block;padding:2px 6px;border-radius:999px;font-size:11px;font-weight:800}
    .tag.hi{background:rgba(255,184,107,.18);color:var(--acc-hi)}
    .tag.mid{background:rgba(196,181,253,.18);color:var(--acc-mid)}
    .tag.low{background:rgba(147,197,253,.18);color:var(--acc-low)}
    .tag.neutral{background:rgba(148,163,184,.2);color:var(--acc-neutral)}

    .inline-icons{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .tiny{width:28px;height:28px;border-radius:6px;object-fit:cover;background:#061016;border:1px solid rgba(255,255,255,.08)}

    .jewels{display:flex;gap:8px;flex-wrap:wrap;padding-top:6px;border-top:1px dashed rgba(255,255,255,.08);margin-top:8px}
    .jewel{width:28px;height:28px;border-radius:6px;background:#12202e;border:1px solid rgba(255,255,255,.1);display:flex;align-items:center;justify-content:center;font-size:11px}

    @media (max-width:1100px){
      .panel{grid-template-columns:1fr}
      .panel .left{border-right:0;border-bottom:1px solid rgba(255,255,255,.06)}
    }
    @media (max-width:980px){ .grid{grid-template-columns:repeat(3,1fr)} }
    @media (max-width:760px){ .grid{grid-template-columns:repeat(2,1fr)} .card{padding:12px} }
    @media (max-width:520px){ .grid{grid-template-columns:1fr} }
    /* 모바일에서는 좌우 배너 숨김 */
    @media (max-width:1200px){ .side-float{display:none} }
  </style>
</head>
<body>
  <div class="container">
    <header style="display:flex;align-items:baseline;gap:8px">
      <h2 style="margin:0;color:var(--gold)">lostamen</h2>
      <span class="small">다중 캐릭터 보드</span>
      <div style="margin-left:auto" class="small" id="status">준비됨 · 1시간 자동 갱신</div>
    </header>

    <!-- 상단 배너 -->
    <section class="card top-banner" id="bn-top"></section>

    <div class="main">
      <section class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
          <button id="refreshAll">전체 갱신</button>
          <span class="small">정렬: 아이템 레벨(내림차순)</span>
        </div>
        <div id="charGrid" class="grid"></div>
      </section>
    </div>

    <!-- 하단 배너 -->
    <section class="card bottom-banner" id="bn-bottom"></section>
  </div>

  <!-- 좌/우 배너(데스크톱만) -->
  <div id="float-left"  class="side-float left"></div>
  <div id="float-right" class="side-float right"></div>

  <!-- 상세 모달 -->
  <div id="detailModal" class="modal" aria-modal="true" role="dialog">
    <div class="panel">
      <div class="left">
        <button class="closeX" id="closeDetail" aria-label="닫기">✕</button>
        <img id="dAvatar" class="hero" alt="avatar"/>
        <div style="margin-top:10px">
          <div style="font-weight:900;color:var(--gold)" id="dName">-</div>
          <div class="small" id="dServer">-</div>
          <div class="chips">
            <div class="chip">직업 <span id="dCls">-</span></div>
            <div class="chip">아이템 레벨 <span id="dIlv">-</span></div>
            <div class="chip">전투력 <span id="dCp">-</span></div>
          </div>
        </div>

        <div class="section">
          <h4>각인</h4>
          <div id="dEngr" class="inline-icons"></div>
        </div>
        <div class="section">
          <h4>아크 패시브</h4>
          <div class="inline-icons" id="dArc"></div>
        </div>
        <div class="section">
          <h4>카드</h4>
          <div id="dCards" class="inline-icons"></div>
        </div>
        <div class="section">
          <h4>부적 · 나침반 · 문장</h4>
          <div id="dRelics" class="inline-icons"></div>
        </div>
      </div>

      <div class="right">
        <div class="detail-grid">
          <div class="section">
            <h4>장비</h4>
            <div id="dGear"></div>
            <div class="jewels" id="dJewels"></div>
          </div>
          <div class="section">
            <h4>악세사리</h4>
            <div id="dAcc"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 디버그 -->
  <button id="__dbgBtn" class="debug-btn" style="position:fixed;right:12px;bottom:12px;z-index:99999;background:#1d2633;border:1px solid rgba(255,255,255,.2);color:#ffd58a;border-radius:10px;padding:8px 10px;font-size:12px;cursor:pointer">디버그</button>
  <div id="__dbgPanel" class="debug-panel" style="display:none;position:fixed;right:12px;bottom:52px;z-index:99999;width:min(92vw,560px);max-height:60vh;overflow:auto;background:#0c121a;border:1px solid rgba(255,255,255,.25);border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.5)">
    <header style="display:flex;justify-content:space-between;align-items:center;padding:8px 10px;background:#111926;border-bottom:1px solid rgba(255,255,255,.12)">
      <div style="font-weight:800;color:#ffd58a;font-size:12px">API Debug</div>
      <div style="display:flex;gap:6px">
        <button id="__dbgClear" class="debug-btn" style="position:static;margin:0;background:#1d2633;border:1px solid rgba(255,255,255,.2);color:#ffd58a;border-radius:10px;padding:6px 8px;font-size:12px;cursor:pointer">지우기</button>
        <button id="__dbgClose" class="debug-btn" style="position:static;margin:0;background:#1d2633;border:1px solid rgba(255,255,255,.2);color:#ffd58a;border-radius:10px;padding:6px 8px;font-size:12px;cursor:pointer">닫기</button>
      </div>
    </header>
    <pre id="__dbgOut" style="margin:0;padding:10px;white-space:pre-wrap;word-break:break-all;font-size:12px;line-height:1.45;color:#cfe1ff"></pre>
  </div>

  <script>
    /* ===== 관리자 설정 ===== */
    const ADMIN_CHARACTERS = ['장용노예2호','애이르','오바때끼','우니꼬쏠쏠','미드미네머너','달빛로드','신쿠fr','아장르카용나','데헌장파튀','워로드너프장본인','소울E컵'].slice(0,20);

    const ADMIN_BANNERS = {
      top:    { img: 'https://jangstar00.github.io/yong/images/topbaner_tech.png',   link: 'https://lostark.game.onstove.com/Class?detail=scouter' },
      left:   { img: 'https://jangstar00.github.io/yong/images/leftbaner_tech.png',  link: 'https://lostark.game.onstove.com/Class?detail=scouter' },
      right:  { img: 'https://jangstar00.github.io/yong/images/rightbaner_mj2.png', link: 'https://lostark.game.onstove.com/Class?detail=scouter' },
      bottom: { img: 'https://jangstar00.github.io/yong/images/topbaner_single2.png', link: 'https://kloa.gg/characters/%EC%95%A0%EC%9D%B4%EB%A5%B4' },
      rightMini: [
        { img: 'https://jangstar00.github.io/yong/images/kloa.png', link: 'https://kloa.gg' },
        { img: 'https://jangstar00.github.io/yong/images/lostbuild.png', link: 'https://lostbuilds.com/' },
        { img: 'https://jangstar00.github.io/yong/images/lostark.png', link: 'https://lostark.game.onstove.com/Main' },
      ]
    };

    /* ===== 절대경로(API 프록시) — 여기 고정 ===== */
    const API_BASE = 'https://yong-qgw8.vercel.app/api';

    const AUTO_MS = 60*60*1000;
    const $ = s => document.querySelector(s);

    /* ===== 디버그 ===== */
    (function(){
      let panel, out, btn, bClose, bClear;
      function init(){
        panel = $('#__dbgPanel'); out = $('#__dbgOut'); btn = $('#__dbgBtn'); bClose=$('#__dbgClose'); bClear=$('#__dbgClear');
        btn?.addEventListener('click', ()=>{ panel.style.display = panel.style.display==='block' ? 'none' : 'block'; });
        bClose?.addEventListener('click', ()=>{ panel.style.display='none'; });
        bClear?.addEventListener('click', ()=>{ out.textContent=''; });
      }
      function ts(){ return new Date().toLocaleTimeString(); }
      window.__dbg = function(label, obj){
        if(!out) init();
        let j; try{ j = typeof obj==='string' ? obj : JSON.stringify(obj,null,2);}catch(e){ j=String(obj); }
        out.textContent = `[${ts()}] ${label}\n${j}\n\n` + out.textContent;
      };
      init();
    })();

    /* ===== 배너 ===== */
    function loadBanners(){
      const map = { top:'bn-top', bottom:'bn-bottom' };
      for(const pos in map){
        const cfg = ADMIN_BANNERS[pos]; const el = document.getElementById(map[pos]); if(!el) continue;
        el.innerHTML = '';
        if(cfg && cfg.img){
          const a=document.createElement('a'); a.href=cfg.link||'#'; a.target='_blank'; a.rel='noopener';
          const img=new Image(); img.src=cfg.img; img.alt=pos+' 배너';
          img.onerror = ()=>{ el.innerHTML = `<div class="small">${pos} 배너 로드 실패</div>`; };
          a.appendChild(img); el.appendChild(a);
        }else el.innerHTML = `<div class="small">${pos} 배너 미지정</div>`;
      }
      const setSide=(side,cfg)=>{
        const wrap = document.getElementById('float-'+side);
        if(!wrap) return;
        wrap.innerHTML='';
        if(cfg && cfg.img){
          const a=document.createElement('a'); a.href=cfg.link||'#'; a.target='_blank'; a.rel='noopener';
          const img=new Image(); img.src=cfg.img; img.alt=side+' 배너';
          img.onerror=()=>{ wrap.innerHTML = `<div class="small">${side} 배너 로드 실패</div>`; };
          a.appendChild(img); wrap.appendChild(a);

          if(side==='right' && Array.isArray(ADMIN_BANNERS.rightMini)){
            const mini=document.createElement('div'); mini.className='side-mini';
            ADMIN_BANNERS.rightMini.forEach(m=>{
              const a2=document.createElement('a'); a2.href=m.link||'#'; a2.target='_blank'; a2.rel='noopener';
              const i2=new Image(); i2.src=m.img; i2.alt='mini';
              a2.appendChild(i2); mini.appendChild(a2);
            });
            wrap.appendChild(mini);
          }
        }
      };
      setSide('left', ADMIN_BANNERS.left);
      setSide('right', ADMIN_BANNERS.right);
    }

    /* ===== 유틸 ===== */
    const setStatus = t => { const s=$('#status'); if(s) s.textContent=t; };
    const parseItemLevel = raw => { if(!raw) return 0; const n=parseFloat(String(raw).replace(/[^0-9.]/g,'')); return isNaN(n)?0:n; };
    const stripTags = s => String(s||'').replace(/<[^>]+>/g,' ').replace(/\s+/g,' ').trim();
    const splitBR   = s => String(s||'').split(/<br\s*\/?>/i);
    const escapeHtml = s => String(s||'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));

    /* ===== 안전 fetch with 캐시버스터 ===== */
    async function fetchJson(url){
      const bust = url.includes('?') ? '&_t=' + Date.now() : '?_t=' + Date.now();
      const full = url + bust;
      __dbg('REQ', full);
      const r = await fetch(full, { mode:'cors', cache:'no-store' });
      const text = await r.text();
      __dbg('RES '+r.status, text.slice(0,1000));
      if(!r.ok) throw new Error('HTTP '+r.status);
      try{ return JSON.parse(text); }catch{ return {}; }
    }

    /* ===== 악세 툴팁 파서 ===== */
    function parseAccessoryFromTooltip(rawTooltip){
      let t; try{ t = JSON.parse(String(rawTooltip)); }catch{ return null; }
      const isGreyLine = s => /#686660/i.test(s||'');
      const quality = t?.Element_001?.value?.qualityValue ?? null;

      const baseHtml = t?.Element_004?.value?.Element_001 || '';
      const baseStats = splitBR(baseHtml).filter(l=>l && !isGreyLine(l)).map(l=>stripTags(l)).filter(Boolean);

      const refineHtml = t?.Element_006?.value?.Element_001 || '';
      const refinements = splitBR(refineHtml)
        .map(l=>stripTags(l)).filter(Boolean)
        .map(txt=>{
          let grade='neutral', label='';
          if(/^\s*상\b/.test(txt)){ grade='hi'; label='상'; txt=txt.replace(/^\s*상\s*/,''); }
          else if(/^\s*중\b/.test(txt)){ grade='mid'; label='중'; txt=txt.replace(/^\s*중\s*/,''); }
          else if(/^\s*하\b/.test(txt)){ grade='low'; label='하'; txt=txt.replace(/^\s*하\s*/,''); }
          return { grade, label:label||'옵션', text:txt };
        });

      const arcPassive = stripTags(t?.Element_008?.value?.Element_001||''); // "깨달음 +13" 등
      return { quality, baseStats, refinements, arcPassive };
    }

    /* ===== 백엔드 응답 맵핑 ===== */
    function mapArmory(resp){
      // resp = { ok:true, data:{...} } 형태 (너의 Vercel API)
      const raw = resp?.data || {};
      const p = {
        CharacterName: raw.name,
        ServerName: raw.server,
        CharacterClassName: raw.cls,
        CharacterImage: raw.avatar,
        ItemMaxLevel: raw.itemLevelText,
        Stats: raw.stats || []
      };

      // combatPower는 문자열 그대로 사용
      const combatPower = raw.combatPower ?? '-';

      // 장비/악세 분리: 너의 백엔드는 equipment 통째 전달함
      const srcEq = Array.isArray(raw.equipment) ? raw.equipment : [];
      const accTypes = ['목걸이','귀걸이','반지','어빌리티 스톤','팔찌'];

      const gear=[], acc=[];
      srcEq.forEach(x=>{
        const item = {
          type: x.Type, name: x.Name, grade: x.Grade || '',
          icon: x.Icon || '', tooltip: x.Tooltip || '', quality: (typeof x.Quality==='number'? x.Quality : null)
        };
        if (accTypes.includes(item.type)) {
          const parsed = parseAccessoryFromTooltip(item.tooltip);
          if (parsed) Object.assign(item, parsed);
          acc.push(item);
        } else {
          gear.push(item);
        }
      });

      // 각인: 문자열 배열로 와있음
      const engraves = Array.isArray(raw.engraves) ? raw.engraves : [];

      // 보석/카드 자리 (백엔드 요약값 있으면 사용)
      const jewels = raw.gems || null;
      const cards  = raw.cards || null;

      return {
        name: p.CharacterName || '-',
        server: p.ServerName || '-',
        cls: p.CharacterClassName || '-',
        avatar: p.CharacterImage || '',
        itemLevelText: p.ItemMaxLevel || '-',
        itemLevelNum: (function(v){ const n=parseFloat(String(v).replace(/[^0-9.]/g,'')); return isNaN(n)?0:n; })(p.ItemMaxLevel),
        combatPower: String(combatPower || '-'),
        gear, acc, jewels, cards,
        engraves
      };
    }

    /* ===== 렌더 ===== */
    function renderGrid(list){
      const wrap = $('#charGrid'); let html='';
      for(let i=0;i<list.length;i++){
        const it=list[i];
        const avatar = it.avatar || 'data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 300 300"><rect width="300" height="300" fill="#061016"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#9aa6b2" font-size="16">NO IMAGE</text></svg>');
        html += `<div class="card-char" data-idx="${i}">
          <img src="${avatar}" alt="${it.name}"/>
          <div class="name">${escapeHtml(it.name||'-')}</div>
          <div class="meta">서버: ${escapeHtml(it.server||'-')}</div>
          <div class="meta">직업: ${escapeHtml(it.cls||'-')}</div>
          <div class="row"><span class="small">아이템 레벨</span><strong>${escapeHtml(it.itemLevelText||'-')}</strong></div>
          <div class="row"><span class="small">전투력</span><strong>${escapeHtml(String(it.combatPower||'-'))}</strong></div>
        </div>`;
      }
      wrap.innerHTML = html;
      wrap.querySelectorAll('.card-char').forEach(card=>{
        card.addEventListener('click', ()=>{
          const idx = Number(card.getAttribute('data-idx'));
          openDetail(list[idx]);
        });
      });
      setStatus(`표시: ${list.length}개 · 정렬: 아이템 레벨`);
    }

    function openDetail(d){
      $('#dAvatar').src = d.avatar || '';
      $('#dName').textContent = d.name;
      $('#dServer').textContent = '서버: '+d.server;
      $('#dCls').textContent = d.cls||'-';
      $('#dIlv').textContent = d.itemLevelText||'-';
      $('#dCp').textContent = d.combatPower||'-';

      // 각인
      const enWrap=$('#dEngr'); enWrap.innerHTML='';
      if((d.engraves||[]).length){ d.engraves.forEach(t=>{ const x=document.createElement('span'); x.className='chip'; x.textContent=t; enWrap.appendChild(x); }); }
      else enWrap.innerHTML='<span class="small">각인 정보 없음</span>';

      // 아크 패시브(악세에서 추출된 텍스트)
      const arc=$('#dArc'); arc.innerHTML='';
      const arcList = (d.acc||[]).map(a=>a.arcPassive).filter(Boolean).slice(0,6);
      if(arcList.length) arcList.forEach(t=>{ const c=document.createElement('span'); c.className='chip'; c.textContent=t; arc.appendChild(c); });
      else arc.innerHTML='<span class="small">표시할 항목 없음</span>';

      // 카드 요약(있으면 노출)
      const cards=$('#dCards'); cards.innerHTML='';
      if(d.cards && d.cards.setName){
        const c=document.createElement('span'); c.className='chip';
        c.textContent = `${d.cards.setName} x${d.cards.setCount} (각성 합 ${d.cards.awakeningTotal})`;
        cards.appendChild(c);
      }else{
        cards.innerHTML='<span class="small">카드 정보 없음</span>';
      }

      // 부적/나침반/문장 자리 (원하면 후처리)
      $('#dRelics').innerHTML = '';

      // 장비
      const gWrap=$('#dGear'); gWrap.innerHTML='';
      (d.gear||[]).forEach(e=>{
        const row=document.createElement('div'); row.className='itemRow';
        row.innerHTML = `
          <img class="icon" src="${e.icon||''}" alt="">
          <div>
            <div class="title">${escapeHtml(e.name||'-')}</div>
            <div class="small" style="opacity:.8">${escapeHtml(e.grade||'')} · ${escapeHtml(e.type||'')}</div>
          </div>
          <div></div>
        `;
        gWrap.appendChild(row);
      });

      // 보석 (백엔드 요약값 있으면 간이 표기)
      const jWrap=$('#dJewels'); jWrap.innerHTML='';
      if(d.jewels && d.jewels.counts){
        const info = `평균레벨 ${d.jewels.avgLevel||'-'} · 멸화 ${d.jewels.counts.damage} · 홍염 ${d.jewels.counts.cooldown}`;
        const tag=document.createElement('span'); tag.className='chip'; tag.textContent=info;
        jWrap.appendChild(tag);
      }

      // 악세사리
      const aWrap=$('#dAcc'); aWrap.innerHTML='';
      (d.acc||[]).forEach(a=>{
        const row=document.createElement('div'); row.className='itemRow';
        const q = Number(a.quality ?? a.qualityValue ?? 0);
        const qClass = q>=90 ? 'good' : q>=70 ? 'mid' : 'bad';
        row.innerHTML = `
          <img class="icon" src="${a.icon||''}" alt="">
          <div>
            <div class="title">${escapeHtml(a.name||'-')}</div>
            <div class="small" style="opacity:.8">${escapeHtml(a.grade||'')} · ${escapeHtml(a.type||'')}</div>
            ${(a.refinements||[]).map(r=>`
              <div class="optLine">
                <span class="tag ${r.grade}">${r.label||'옵션'}</span>
                <span class="small">${escapeHtml(r.text)}</span>
              </div>
            `).join('')}
            ${(a.baseStats||[]).length? `<div class="small" style="margin-top:6px;opacity:.85">${a.baseStats.map(s=>escapeHtml(s)).join(' · ')}</div>`:''}
          </div>
          <div><span class="qBadge ${qClass}">Q ${isNaN(q)?'-':q}</span></div>
        `;
        aWrap.appendChild(row);
      });

      $('#detailModal').classList.add('on');
    }

    /* ===== 데이터 로딩 ===== */
    async function fetchChar(name){
      const url = `${API_BASE}/character?name=${encodeURIComponent(name)}`;
      try{
        const j = await fetchJson(url);
        if(!j.ok) throw new Error('upstream fail');
        const mapped = mapArmory(j);
        return mapped;
      }catch(e){
        __dbg('ERR '+name, String(e?.message||e));
        return {
          name, server:'-', cls:'-', avatar:'',
          itemLevelText:'-', itemLevelNum:0, combatPower:'-',
          gear:[], acc:[], jewels:null, cards:null, engraves:[]
        };
      }
    }

    async function refreshAll(){
      try{
        setStatus(navigator.onLine? '전체 불러오는 중...' : '오프라인: 캐시/모의 데이터 표시');
        const list = await Promise.all(ADMIN_CHARACTERS.map(fetchChar));
        list.sort((a,b)=> b.itemLevelNum - a.itemLevelNum);
        renderGrid(list);
        try{ localStorage.setItem('gridCache_v5', JSON.stringify(list)); }catch{}
      }catch(e){
        __dbg('refreshAll ERR', String(e?.message||e));
        try{
          const cache = localStorage.getItem('gridCache_v5');
          if(cache){ renderGrid(JSON.parse(cache)); setStatus('오프라인 캐시 표시'); return; }
        }catch{}
        setStatus('네트워크 실패: 모의 데이터 표시');
      }
    }

    function boot(){
      loadBanners();
      refreshAll();
      $('#refreshAll').addEventListener('click', refreshAll);
      setInterval(refreshAll, AUTO_MS);

      $('#closeDetail').addEventListener('click', ()=>$('#detailModal').classList.remove('on'));
      $('#detailModal').addEventListener('click', e=>{ if(e.target.id==='detailModal') $('#detailModal').classList.remove('on'); });

      window.addEventListener('online',  ()=>{ setStatus('온라인 복구: 재동기화 중...'); refreshAll(); });
      window.addEventListener('offline', ()=>{ setStatus('오프라인: 캐시/모의 데이터 표시'); });
    }

    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
